# ğŸš€ Clean venv-based DevContainer for Dual-Face GPU Pipeline
# Ubuntu 24.04 + Python 3.10 + venv ê²©ë¦¬ í™˜ê²½
# PEP 668 ìš°íšŒ, ì¦‰ì‹œ ê°œë°œ ê°€ëŠ¥í•œ êµ¬ì„±

FROM ubuntu:24.04

# =============================================================================
# ğŸ”§ ê¸°ë³¸ í™˜ê²½ ì„¤ì •
# =============================================================================
ENV DEBIAN_FRONTEND=noninteractive
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64
ENV PYTHONPATH=/workspace

# venv ê²½ë¡œ ì„¤ì • (ë³¼ë¥¨ ë§ˆìš´íŠ¸ ì˜í–¥ ì—†ëŠ” ìœ„ì¹˜)
ENV VENV_PATH=/opt/venv
ENV PATH=${VENV_PATH}/bin:${PATH}
ENV VIRTUAL_ENV=${VENV_PATH}

# =============================================================================
# ğŸ“¦ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ìµœì†Œí•œìœ¼ë¡œ ì¶•ì†Œ)
# =============================================================================

# Python 3.10 ì €ì¥ì†Œ ì¶”ê°€ (Ubuntu 24.04 ê¸°ë³¸ì€ 3.12)
RUN apt-get update && apt-get install -y software-properties-common && \
    add-apt-repository ppa:deadsnakes/ppa -y && \
    apt-get update

# í•µì‹¬ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜
RUN apt-get install -y \
    # Python 3.10 ì „ì²´ ìŠ¤íƒ
    python3.10 \
    python3.10-dev \
    python3.10-venv \
    python3.10-distutils \
    python3-numpy \
    # ë¹Œë“œ ë„êµ¬
    build-essential \
    cmake \
    pkg-config \
    # ê°œë°œ ë„êµ¬
    git \
    wget \
    curl \
    vim \
    htop \
    nvtop \
    unzip \
    # ë¯¸ë””ì–´ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ìµœì†Œí•œ)
    libfreetype6 \
    libpng16-16 \
    libtiff6 \
    libtiff-dev \
    # GStreamer (PyAV ì˜ì¡´ì„±)
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-libav \
    # FFmpeg (ê¸°ë³¸ íŒ¨í‚¤ì§€ + ì‹¤í–‰ íŒŒì¼)
    ffmpeg \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswscale-dev \
    libswresample-dev \
    libavfilter-dev \
    libavdevice-dev \
    # X11 (GUI ë°±ì—”ë“œìš©)
    libx11-6 \
    libxext6 \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# ğŸ¯ CUDA 12.8 ì„¤ì¹˜ (RTX 5090 ì§€ì›)
# =============================================================================
RUN apt-get update && \
    apt-get install -y ca-certificates curl gnupg && \
    install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/3bf863cc.pub -o /etc/apt/keyrings/cuda.asc && \
    chmod a+r /etc/apt/keyrings/cuda.asc && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/cuda.asc] https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/ /" > /etc/apt/sources.list.d/cuda.list && \
    apt-get update && \
    # í•µì‹¬ CUDA íŒ¨í‚¤ì§€ë§Œ ì„¤ì¹˜ (ìš©ëŸ‰ ìµœì í™”)
    apt-get -y install \
        cuda-toolkit-12-8 \
        cuda-cudart-12-8 \
        libcublas-12-8 \
        libcublas-dev-12-8 \
        libcufft-12-8 \
        libcufft-dev-12-8 \
        cudnn9-cuda-12 \
        && rm -rf /var/lib/apt/lists/*

# =============================================================================
# ğŸ§  TensorRT ì„¤ì¹˜ (ì‹œìŠ¤í…œ ë ˆë²¨)
# =============================================================================
RUN apt-get update && \
    apt-get install -y \
        tensorrt \
        python3-libnvinfer-dev \
        libnvinfer-plugin-dev \
        || echo "âš ï¸ TensorRT ì‹œìŠ¤í…œ ì„¤ì¹˜ ì‹¤íŒ¨ - venvì—ì„œ pipìœ¼ë¡œ ì¬ì‹œë„" && \
    rm -rf /var/lib/apt/lists/*

# =============================================================================
# ğŸ¬ OpenCV CUDA ì„¤ì¹˜ (ê²€ì¦ëœ DEB íŒ¨í‚¤ì§€)
# =============================================================================
# í˜¸ìŠ¤íŠ¸ì—ì„œ ë¹Œë“œëœ OpenCV CUDA 4.13.0 DEB íŒ¨í‚¤ì§€ ë³µì‚¬
COPY opencv-cuda-4.13.0_amd64.deb /tmp/
RUN dpkg -i /tmp/opencv-cuda-4.13.0_amd64.deb && \
    apt-get update && \
    apt-get install -f -y && \
    rm /tmp/opencv-cuda-4.13.0_amd64.deb

# =============================================================================
# ğŸ Python í™˜ê²½ êµ¬ì„± (venv ê¸°ë°˜)
# =============================================================================

# Python 3.10ì„ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •
RUN ln -sf /usr/bin/python3.10 /usr/bin/python && \
    ln -sf /usr/bin/python3.10 /usr/bin/python3

# ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /workspace

# venv ìƒì„± (ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ì™€ ì™„ì „ ê²©ë¦¬)
RUN python3.10 -m venv ${VENV_PATH} && \
    # venv ë‚´ì—ì„œ pip ìµœì‹ í™” (venv ë‚´ë¶€ì´ë¯€ë¡œ PEP 668 ì ìš© ì•ˆë¨)
    ${VENV_PATH}/bin/pip install --upgrade pip setuptools wheel

# =============================================================================
# ğŸ”¥ PyTorch ì„¤ì¹˜ (venv ë‚´, RTX 5090 ìµœì í™”)
# =============================================================================
RUN ${VENV_PATH}/bin/pip install --no-cache-dir --pre \
    torch torchvision torchaudio \
    --index-url https://download.pytorch.org/whl/nightly/cu128

# TensorRT ì¬ì„¤ì¹˜ (CUDA 12.8 í˜¸í™˜ ë²„ì „)
RUN ${VENV_PATH}/bin/pip uninstall -y tensorrt tensorrt-cu12 tensorrt-cu12-bindings tensorrt-cu12-libs && \
    ${VENV_PATH}/bin/pip install --no-cache-dir tensorrt-cu12==10.5.0

# =============================================================================
# ğŸ“¹ PyNvVideoCodec ì„¤ì¹˜ (VPF ëŒ€ì²´)
# =============================================================================
RUN ${VENV_PATH}/bin/pip install --no-cache-dir PyNvVideoCodec

# =============================================================================
# ğŸ“‹ Python ì˜ì¡´ì„± ì„¤ì¹˜ (venv ë‚´, ê²½ëŸ‰í™”ëœ íŒ¨í‚¤ì§€ ëª©ë¡)
# =============================================================================
COPY requirements.txt /tmp/

# 1ë‹¨ê³„: ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (PyAV ì œì™¸)
RUN ${VENV_PATH}/bin/pip install --no-cache-dir -r /tmp/requirements.txt

# PyAVë¥¼ ì†ŒìŠ¤ì—ì„œ ë¹Œë“œ (NVENC/NVDEC ì§€ì›)
RUN ${VENV_PATH}/bin/pip install av==11.0.0 --no-binary av --no-cache-dir

# 2ë‹¨ê³„: ì˜ì¡´ì„± ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ --no-depsë¡œ AI ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
RUN ${VENV_PATH}/bin/pip install --no-deps \
    ultralytics==8.0.200 \
    facenet-pytorch==2.5.3

# ì •ë¦¬
RUN rm /tmp/requirements.txt

# OpenCVë¥¼ venvì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±
RUN ln -s /usr/local/lib/python3.10/site-packages/cv2.so ${VENV_PATH}/lib/python3.10/site-packages/cv2.so || \
    ln -s /usr/lib/python3.10/dist-packages/cv2.so ${VENV_PATH}/lib/python3.10/site-packages/cv2.so || \
    echo "âš ï¸ OpenCV ì‹¬ë³¼ë¦­ ë§í¬ëŠ” ëŸ°íƒ€ì„ì—ì„œ ì„¤ì •"

# =============================================================================
# ğŸš€ venv ìë™ í™œì„±í™” ì„¤ì •
# =============================================================================

# .bashrcì— venv ìë™ í™œì„±í™” ì¶”ê°€
RUN echo "# Auto-activate venv for DevContainer" >> /root/.bashrc && \
    echo "if [ -d \"/opt/venv\" ] && [ -z \"\$VIRTUAL_ENV\" ]; then" >> /root/.bashrc && \
    echo "    source /opt/venv/bin/activate" >> /root/.bashrc && \
    echo "    echo 'âœ… venv activated: /opt/venv'" >> /root/.bashrc && \
    echo "fi" >> /root/.bashrc

# =============================================================================
# ğŸ§ª ë¹Œë“œ ì‹œì  ê²€ì¦ (GPU ì—†ì´ ê°€ëŠ¥í•œ ê²ƒë“¤ë§Œ)
# =============================================================================
RUN echo "ğŸ§ª ë¹Œë“œ ì‹œì  ê²€ì¦ ì‹œì‘..." && \
    # PyTorch í™•ì¸
    ${VENV_PATH}/bin/python -c "import torch; print(f'âœ… PyTorch: {torch.__version__}')" && \
    # PyAV í™•ì¸ 
    ${VENV_PATH}/bin/python -c "import av; print(f'âœ… PyAV: {av.__version__}')" && \
    # OpenCV í™•ì¸
    ${VENV_PATH}/bin/python -c "import cv2; print(f'âœ… OpenCV: {cv2.__version__}')" && \
    # TensorRT í™•ì¸ (optional)
    ${VENV_PATH}/bin/python -c "import tensorrt; print(f'âœ… TensorRT: {tensorrt.__version__}')" || echo "âš ï¸ TensorRTëŠ” ëŸ°íƒ€ì„ì—ì„œ í™•ì¸" && \
    # PyNvVideoCodec í™•ì¸ (optional)
    ${VENV_PATH}/bin/python -c "import PyNvVideoCodec; print('âœ… PyNvVideoCodec: OK')" || echo "âš ï¸ PyNvVideoCodecëŠ” ëŸ°íƒ€ì„ì—ì„œ í™•ì¸" && \
    echo "ğŸ‰ ë¹Œë“œ ì‹œì  ê²€ì¦ ì™„ë£Œ!"

# =============================================================================
# ğŸ”§ ëŸ°íƒ€ì„ ì„¤ì •
# =============================================================================

# GPU ì ‘ê·¼ ê¶Œí•œ
RUN usermod -aG video root

# í¬íŠ¸ ë…¸ì¶œ (ê°œë°œìš©)
EXPOSE 8000 8888 5000

# ë‹¨ìˆœí•œ bash ì‹œì‘ (venvëŠ” .bashrcì—ì„œ ìë™ í™œì„±í™”)
CMD ["/bin/bash"]