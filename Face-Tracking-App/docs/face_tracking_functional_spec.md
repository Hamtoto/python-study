# Face Tracking 기반 발화 구간 영상 생성 기능 정의서

## 1. 문서 목적
본 문서는 Face Tracking 기반 발화 영상 처리 시스템에 포함된 각 기능이 **어떻게 작동해야 하는지**를 개발자가 구현 가능한 수준으로 상세하게 정의한 기능 명세서입니다. 이 문서는 요구사항 정의서를 기반으로 작성되며, 실제 소프트웨어 구현 시 기준이 되는 문서입니다.

---

## 2. 기능 목록 요약

| 기능 ID | 기능 명 | 적용 모드 |
|---------|---------|------------|
| F-01 | 입력 영상 디렉토리 처리 | 공통 |
| F-02 | 발화 구간 추출 (VAD) | 공통 |
| F-03 | 얼굴 검출 및 트래킹 | 공통 |
| F-04 | 얼굴 임베딩 생성 | 공통 |
| F-05 | 1인 화자 추정 | SINGLE |
| F-06 | 2인 화자 추정 | DUAL |
| F-07 | 프레임 크롭 처리 | 공통 |
| F-08 | 오디오-프레임 싱크 | 공통 |
| F-09 | 세그먼트 분할 저장 | 공통 |

---

## 3. 기능 상세 정의

### F-01. 입력 영상 디렉토리 처리
- `/videos/input/` 디렉토리 내 `.mp4`, `.mov` 영상 파일을 순차 처리
- 예외: 0바이트, 손상된 영상 파일은 무시하고 로그 기록

### F-02. 발화 구간 추출 (VAD)
- pyannote.audio 기반 VAD 모델을 사용
- `SILENCE_THRESHOLD_SEC`(기본값: 2.0초) 이상 무음 구간은 제거
- 출력: `[start_time, end_time]` 리스트 형태의 타임라인 배열

### F-03. 얼굴 검출 및 트래킹
- MTCNN 기반 얼굴 감지
- 프레임마다 검출된 얼굴 좌표 및 추정 bounding box 리턴
- tracking_id는 frame 기준 고유 인덱스로 임시 부여 (임베딩 비교 전)

### F-04. 얼굴 임베딩 생성
- FaceNet (InceptionResnetV1) 기반 임베딩 벡터(512차원) 생성
- cosine 유사도 기반으로 face_id 간 유사성 평가
- 설정값: `SIMILARITY_THRESHOLD` (기본 0.6)

### F-05. 1인 화자 추정 (SINGLE 모드)
- 전체 영상에서 등장한 모든 face_id의 프레임 수 카운트
- 가장 많이 등장한 face_id 1개를 추정 화자로 지정
- 해당 face_id가 등장하는 발화 구간만 유지

### F-06. 2인 화자 추정 (DUAL 모드)
- 각 발화 구간 내 등장한 face_id별 등장 프레임 수를 집계
- 상위 2명을 `speaker_a`, `speaker_b`로 간주하여 별도 저장
- 1명만 등장 시는 `speaker_a`만 저장, fallback 없음

### F-07. 프레임 크롭 처리
- 얼굴 중심 기준으로 정사각형 250x250 크기로 잘라냄
- 프레임 해상도가 작을 경우 예외 로그 남기고 skip

### F-08. 오디오-프레임 싱크
- 발화 구간의 start/end 기준으로 오디오 클립 추출
- 해당 구간 프레임 수와 오디오 길이를 정렬
- 싱크 mismatch 발생 시 경고 로그 출력

### F-09. 세그먼트 분할 저장
- config에 정의된 `SEGMENT_DURATION_SEC` 기준 (기본: 10초)
- 각 화자별로 해당 구간을 파일 단위로 저장
- 저장 경로:
  - SINGLE: `/videos/output/single/`
  - DUAL: `/videos/output/speaker_a/`, `/speaker_b/`
- 파일명 예시: `segment_000.mp4`, `segment_001.mp4`

---

## 4. 공통 처리 정책

| 항목 | 정책 |
|------|------|
| 프레임 내 얼굴 없음 | 해당 프레임 제거 |
| 구간 내 얼굴 없음 | 해당 segment 저장 생략 |
| 1초 미만 구간 | 저장 생략 or 병합 (추후 옵션) |
| 오류 발생 | 로그 기록 후 다음 영상으로 continue |

---

## 5. 입력/출력 형식 요약

### 입력
- `/videos/input/*.mp4`

### 출력 (예시)
```
/videos/output/single/segment_000.mp4
/videos/output/speaker_a/segment_000.mp4
/videos/output/speaker_b/segment_000.mp4
```

---

## 6. 문서 이력
| 버전 | 작성일 | 작성자 | 비고 |
|-------|---------|----------|------|
| v1.0 | 2025-08-01 | Ethan Ko | 최초 기능 정의 |

> 본 기능 정의서는 개발자가 실제로 구현해야 할 함수/모듈의 입력, 출력, 처리 흐름을 기준으로 상세하게 정리한 문서입니다. 추후 테스트 케이스 및 사양서와 연계되어 기능 검수의 기준이 됩니다.

